<link rel="import" href="../polymer/polymer.html">

<!--
`klima-dashboard`
dashboard

@demo demo/index.html
-->

<dom-module id="klima-dashboard">
  <template>
    <style>
      :host {
        display: block;
      }
      #dashboard {
        position: relative;
        width: 700px;
        height: 700px;
        border-style: solid;
      }
    </style>

    <h2>Hello [[prop1]]!</h2>
    <div id="dashboard">
      <content id="tiles" select="klima-dashboard-tile"></content>
    </div>
  </template>

  <script>
    Polymer({
      is: 'klima-dashboard',
      properties: {
        prop1: {
          type: String,
          value: 'klima-dashboard',
        },
        dashboardMap: {
          type: Object,
          value: function() {
            return new Map();
          }
        }
      },

      attached: function() {
        var tiles = this.getContentChildren('#tiles');
        //Add tiles
        for(var i=0; i < tiles.length; i++) {
          for(var j=0; j <= tiles[i].overlap; j++) {
            this._addTileToDashboard(tiles[i], tiles[i].row + j);
          }
        }
        this._sortDashboardMap();
        //this._adjustTilesWidth();
        //this._printDashboard();
        this._drawDashboard();
      },

      _sortDashboardMap: function() {
        var dashboardMap = this.dashboardMap;
        dashboardMap.forEach(function(v,k) {
          var sorted = [];
          var smallestOrder = null;
          var numberTiles = v.length;
          for(var i=0; i < numberTiles; i++) {
            var len = v.length;
            var min = Infinity;
            var minTile = null;
            var minIndex = -1;
            while (len--) {
              if (v[len].order[k-v[len].row] < min) {
                min = v[len].order[k-v[len].row];
                minTile = v[len];
                minIndex = len;
              }
            }
            if(minTile.row == k) {
              if(sorted.length == 0) {
                minTile.leftNeighbour = null;
              } else {
                minTile.leftNeighbour = sorted[sorted.length-1];
              }
            }
            if(sorted.length != 0) {
              if(sorted[sorted.length-1].row == k) {
                sorted[sorted.length-1].rightNeighbour = minTile;
              }
            }
            sorted.push(minTile);
            v.splice(minIndex, 1);
          }
          dashboardMap.set(k, sorted);
        });
      },

      _addTileToDashboard: function(tile, row) {
        if(tile.overlap+1 != tile.order.length) {
          console.warn(tile.outerHTML + "\nNo order for row " + row);
        }
        if(this.dashboardMap.has(row)) {
          this.dashboardMap.get(row).push(tile);
        } else {
          this.dashboardMap.set(row, [tile]);
        }
      },

      _adjustTilesWidth: function() {
        this.dashboardMap.forEach(function(v,k) {
          console.log("ROW: " + k);
          remainingWidth = 100;
          remainingTiles = [];
          v.forEach(function(tile) {
            console.log(tile.innerText);
            if(tile.width == 0) {
              console.log("PUSH");
              remainingTiles.push(tile);
            } else {
              console.log(tile.width);
              remainingWidth -= tile.width;
            }
          });
          // Hier
          if(remainingWidth < 0) {
            console.warn("Overfull row");
          }
          remainingTiles.forEach(function(tile) {
            tile.width = remainingWidth/remainingTiles.length;
          });
        });
      },

      _printDashboard: function() {
        this.dashboardMap.forEach(function(v,k) {
          v.forEach(function(node) {
            if(node.row == k) {
              console.log(node.innerText + " has a width of " + node.width);
              if(node.leftNeighbour != null) {
                console.log("Left Neighbour of " + node.innerText + " is " + node.leftNeighbour.innerText);
              } else {
                console.log("Left Neighbour of " + node.innerText + " is NULL");
              }
            }
          })
        });
      },

      _drawDashboard: function() {
        var dashboard = this.$.dashboard;
        var dashboardHeight = window.getComputedStyle(dashboard, null).getPropertyValue("height");
        var dashboardWidth = window.getComputedStyle(dashboard, null).getPropertyValue("width");
        var dashboardLeft = window.getComputedStyle(dashboard, null).getPropertyValue("left");
        var rowHeight = parseInt(dashboardHeight, 10)/this.dashboardMap.size;
        var getOffset = this.getOffset;
        this.dashboardMap.forEach(function(v,k) {
          v.forEach(function(tile) {
            if(tile.row != k) {return;}
            var leftNeighbour = tile.leftNeighbour;
            var left = 0;

            //new
            if(tile.width == 0) {
              var rightNeighbour = tile.rightNeighbour;
              var remainingTiles = 1;
              var reservedWidth = 0;
              while (rightNeighbour != null && !rightNeighbour.tiledrawn) {
                console.log(tile.innerText + ": " + rightNeighbour.innerText);
                if(rightNeighbour.width == 0) {
                  remainingTiles += 1;
                } else {
                  reservedWidth += rightNeighbour.width/100*parseFloat(dashboardWidth, 10);
                }
                rightNeighbour = rightNeighbour.rightNeighbour;
              }
              var end = 0;
              var start = 0;
              if(tile.leftNeighbour == null) {
                start = 0;
              } else {
                console.log("LEFT: " + parseFloat(tile.leftNeighbour.style.left, 10));
                start = parseFloat(tile.leftNeighbour.style.left, 10) + parseFloat(tile.leftNeighbour.style.width, 10);
              }
              if(rightNeighbour == null) {
                end = parseFloat(dashboardLeft, 10) + parseFloat(dashboardWidth, 10);
                console.log("END 700???");
              } else {
                end = parseFloat(rightNeighbour.style.left, 10)
              }
              console.log("START: " + start + " END: " + end + " reservedWidth: " + reservedWidth);
              var remainingWidth = end - start - reservedWidth;
              var width = remainingWidth/remainingTiles;
              if(width < 0) {
                tile.style.width = '0px'
              } else {
                console.log(width);
                tile.style.width = width + 'px';
              }
            //
            } else {
               tile.style.width = (tile.width/100*parseFloat(dashboardWidth, 10)) + 'px';
            }

            while(leftNeighbour != null) {
              left += parseFloat(leftNeighbour.style.width, 10)
              leftNeighbour = leftNeighbour.leftNeighbour;
            }
            tile.style.left = left + 'px';
            tile.style.top = (tile.row-1)*rowHeight + 'px';
            tile.style.height = (tile.overlap+1)*rowHeight + 'px';
            tile.tiledrawn = true;
          });
        });
      }
    });
  </script>
</dom-module>
