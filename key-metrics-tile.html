<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="./shared-tile-styles.html">
<!--
`key-metrics-tile`
tile with key metrics

-->

<dom-module id="key-metrics-tile">
  <template>
    <style include="shared-tile-styles">
      :host {
        display: block;
        height: 100%;
        width: 100%;
      }
      table {
        border: 0;
        border-collapse: separate;
        border-spacing: 0 5px;
        text-align: left;
        width:100%;
      }
      thead tr th {
        font-weight: normal;
        border-bottom: 1px solid grey;
        border-collapse: separate;
        border-spacing: 5px 5px;
      }
      .growthContainer {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .progress {
        height: 20px;
      }
      .scaleContainer {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }
      .tileContainer {
        height: 100%;
        width: 100%;
        @apply(--layout-vertical);
      }
      .flexchild {
        @apply(--layout-flex);
      }
      td {
        height: 18%;
      }
      .scaleRow {
        height: 10%;
      }
    </style>
    <iron-ajax id="ajax"
      auto
      handle-as="json"
      on-response="handleResponse"
      on-error="handleError">
    </iron-ajax>
    <div >
      <h3 class="caption">Key Metriken</h3>
      <table >
        <thead>
          <tr>
            <th>Vergangene 5 Perioden</th>
            <th>Metrik</th>
            <th>Wachstum in Prozent</th>
            <th>Aktuell</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <google-chart class="spark"
                type="line"
                data="[[contributionMargin]]"
                options='{"backgroundColor": {"fill": "transparent"}, "legend": {"position": "none"}, "hAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"},"vAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"}}'>
              </google-chart>
            </td>
            <td>Deckungsbeiträge</td>
            <td>
              <div class="growthContainer">
                <paper-progress class="progress negativeL" value="50"></paper-progress>
                <paper-progress class="progress positiveR" value="0"></paper-progress>
              </div>
            </td>
            <td>[[_actualValue(contributionMargin)]]</td>
          </tr>
          <tr>
            <td>
              <google-chart class="spark"
                type="line"
                data="[[centralAndFunctionalCosts]]"
                options='{"backgroundColor": {"fill": "transparent"}, "legend": {"position": "none"}, "hAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"},"vAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"}}'>
              </google-chart>
            </td>
            <td>Kosten Zentral- und Funktionsbereiche</td>
            <td>
              <div class="growthContainer">
                <paper-progress class="progress negativeL" value="50"></paper-progress>
                <paper-progress class="progress positiveR" value="0"></paper-progress>
              </div>
            </td>
            <td>[[_actualValue(centralAndFunctionalCosts)]]</td>
          </tr>
          <tr>
            <td>
              <google-chart class="spark"
                type="line"
                data="[[overplus]]"
                options='{"backgroundColor": {"fill": "transparent"}, "legend": {"position": "none"}, "hAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"},"vAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"}}'>
              </google-chart>
            </td>
            <td>Überschuss</td>
            <td>
              <div class="growthContainer">
                <paper-progress class="progress negativeL" value="50"></paper-progress>
                <paper-progress class="progress positiveR" value="0"></paper-progress>
              </div>
            </td>
            <td>[[_actualValue(overplus)]]</td>
          </tr>
          <tr>
            <td>
              <google-chart class="spark"
                type="line"
                data="[[occupancyRate]]"
                options='{"backgroundColor": {"fill": "transparent"}, "legend": {"position": "none"}, "hAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"},"vAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"}}'>
              </google-chart>
            </td>
            <td>Belegungsgrad</td>
            <td>
              <div class="growthContainer">
                <paper-progress class="progress negativeL" value="50"></paper-progress>
                <paper-progress class="progress positiveR" value="0"></paper-progress>
              </div>
            </td>
            <td>[[_actualValue(occupancyRate)]]</td>
          </tr>
          <tr>
            <td>
              <google-chart class="spark"
                type="line"
                data="[[quality]]"
                options='{"backgroundColor": {"fill": "transparent"}, "legend": {"position": "none"}, "hAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"},"vAxis": {"baselineColor": "none","ticks": [],"textPosition": "none"}}'>
              </google-chart>
            </td>
            <td>Gesamtqualität</td>
            <td>
              <div class="growthContainer">
                <paper-progress class="progress negativeL" value="50"></paper-progress>
                <paper-progress class="progress positiveR" value="0"></paper-progress>
              </div>
            </td>
            <td>[[_actualValue(quality)]]</td>
          </tr>
          <tr class="scaleRow">
            <td></td>
            <td></td>
            <td>
              <div class="scaleContainer" style="font-size: 75%;">
                <div>-25%</div>
                <div>0%</div>
                <div>25%</div>
              </div>
            </td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
  </template>

  <script>
    Polymer({
      is: 'key-metrics-tile',
      properties: {
        sourceUrl: {
          type: String
        },
        contributionMargin: {
          type: Array
        },
        centralAndFunctionalCosts: {
          type: Array
        },
        overplus: {
          type: Array
        },
        occupancyRate: {
          type: Array
        },
        quality: {
          type: Array
        }
      },
      ready: function() {
        if(this.sourceUrl != null) {
          this.$.ajax.url = this.sourceUrl;
        } else {
          this.handleError()
        }
      },
      handleResponse: function(e) {
        this._processData(e.detail.response);
      },
      handleError: function() {
        console.warn("No Data");
      },
      _processData: function(keyMetricData) {
        this.contributionMargin = this._buildDataForSpark(keyMetricData.contributionMargin);
        this.centralAndFunctionalCosts = this._buildDataForSpark(keyMetricData.centralAndFunctionalCosts);
        this.overplus = this._buildDataForSpark(keyMetricData.overplus);
        this.occupancyRate = this._buildDataForSpark(keyMetricData.occupancyRate);
        this.quality = this._buildDataForSpark(keyMetricData.quality);
      },
      _buildDataForSpark: function(arrayWithData) {
        sparkData = [["Periode", ""]];
        for(var i=0; i < arrayWithData.length; i++) {
          sparkData.push([i.toString(), arrayWithData[i]]);
        }
        return sparkData;
      },
      _actualValue: function(array) {
        return array[array.length-1];
      }
    });
  </script>
</dom-module>
